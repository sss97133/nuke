# Telegram Restoration Intake System

Photo intake system for restoration companies using Telegram.

## Overview

```
Boss → Generate Invite Code → Technician Joins → Sets Vehicle → Sends Photos → Business Gets Data
```

## Database Schema

### Tables

**`telegram_work_submissions`** - Photo submissions from technicians
- Links to: telegram_technicians, businesses, vehicles
- Stores: photo URLs, AI analysis, work type, description
- Status: received → processing → processed → logged

**`business_invite_codes`** - Onboarding codes
- Generated by business owner/manager
- Max uses, expiration, role type
- Used by technicians to join a business

**`telegram_technicians`** additions:
- `business_id` - Which business they work for
- `invite_code_used` - How they joined
- `active_vehicle_id` - Current vehicle assignment

### SQL Functions

```sql
-- Generate invite code for a business
SELECT generate_invite_code(
  'business-uuid',        -- business_id
  'user-uuid',           -- created_by (optional)
  'technician',          -- role_type
  10,                    -- max_uses
  30                     -- expires in days
);

-- Use invite code (called by bot)
SELECT use_invite_code('ABC12345', 123456789);  -- code, telegram_id
```

### Views

**`business_telegram_submissions`** - Denormalized view for easy querying
```sql
SELECT * FROM business_telegram_submissions
WHERE business_id = 'xxx'
ORDER BY received_at DESC;
```

## Telegram Bot Commands

| Command | Description |
|---------|-------------|
| `/start CODE` | Join a business using invite code |
| `/vehicle VIN` | Set active vehicle by VIN |
| `/status` | Check current assignment |
| `/done` | Clear active vehicle |
| `/help` | Show help |

### Onboarding Flow

1. Technician opens Telegram bot
2. Sends `/start ABC12345` (invite code from boss)
3. Bot links technician to business
4. Technician sets vehicle: `/vehicle WBA3A5C51CF123456`
5. Technician sends photos
6. Photos are logged to vehicle timeline
7. Business can pull data via API

## Business API

Base URL: `https://xxx.supabase.co/functions/v1/api-v1-business-data`

### Authentication

**API Key:**
```
X-API-Key: nk_live_xxxxx
```

**Bearer Token:**
```
Authorization: Bearer <jwt>
```

### Endpoints

#### GET /summary
Dashboard stats for the business.

```json
{
  "submissions": {
    "today": 5,
    "this_week": 23,
    "this_month": 89
  },
  "technicians_active": 3,
  "vehicles_in_service": 7,
  "work_type_breakdown": {
    "body_work": 15,
    "paint": 8,
    "mechanical": 5
  },
  "recent_activity": [...]
}
```

#### GET /submissions
List photo submissions.

**Query params:**
- `limit` - Max 100, default 50
- `offset` - For pagination
- `since` - ISO date filter
- `until` - ISO date filter
- `vehicle_id` - Filter by vehicle
- `technician_id` - Filter by technician
- `status` - Filter by processing status

```json
{
  "data": [
    {
      "id": "xxx",
      "message_text": "Sanding the rocker panel",
      "photo_urls": ["https://..."],
      "received_at": "2026-02-05T12:00:00Z",
      "detected_work_type": "body_work",
      "detected_description": "Rust repair on driver side",
      "vehicles": {
        "year": 1967,
        "make": "Chevrolet",
        "model": "Camaro"
      },
      "telegram_technicians": {
        "display_name": "Mike"
      }
    }
  ],
  "total": 89,
  "pagination": {
    "limit": 50,
    "offset": 0,
    "hasMore": true
  }
}
```

#### GET /vehicles
List vehicles in service.

**Query params:**
- `status` - active, sold, archived, all
- `service_status` - currently_in_service, service_archive

#### GET /technicians
List connected technicians.

## Deployment

```bash
# Deploy bot
supabase functions deploy telegram-restoration-bot --no-verify-jwt

# Deploy API
supabase functions deploy api-v1-business-data --no-verify-jwt

# Set up webhook (after deploy)
curl "https://xxx.supabase.co/functions/v1/telegram-restoration-bot?setup=true"
```

## Files

```
database/migrations/20260205_telegram_restoration_intake.sql
supabase/functions/telegram-restoration-bot/index.ts
supabase/functions/api-v1-business-data/index.ts
```

## Integration with Existing Systems

- Uses existing `businesses` table (not a new orgs table)
- Uses existing `vehicles` table
- Uses existing `vehicle_timeline` for events
- Uses existing `vehicle_observations` for unified data
- Uses existing `api_keys` for API authentication
- Compatible with existing `business_user_roles` permissions
