<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Map — Nuke</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --bg: #f5f5f5;
      --surface: #ebebeb;
      --surface-hover: #e0e0e0;
      --border: #bdbdbd;
      --border-focus: #2a2a2a;
      --text: #2a2a2a;
      --text-secondary: #666666;
      --text-disabled: #999999;
      --accent: #2a2a2a;
      --accent-dim: rgba(42, 42, 42, 0.08);
      --success: #16825d;
      --font-family: Arial, sans-serif;
      --font-mono: 'SF Mono', Monaco, monospace;
      --radius: 4px;
      --transition: 0.12s ease;
      --fs-8: 8px;
      --fs-9: 9px;
      --fs-10: 10px;
      --fs-11: 11px;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #1e1e1e;
        --surface: #252526;
        --surface-hover: #2d2d30;
        --border: #3e3e42;
        --border-focus: #cccccc;
        --text: #cccccc;
        --text-secondary: #858585;
        --text-disabled: #656565;
        --accent: #cccccc;
        --accent-dim: rgba(204, 204, 204, 0.12);
      }
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: var(--font-family);
      font-size: var(--fs-10);
      background: var(--bg);
      color: var(--text);
      line-height: 1.3;
      -webkit-font-smoothing: antialiased;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 12px; }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
      margin-bottom: 8px;
    }
    .title {
      font-size: var(--fs-11);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 4px;
    }
    .btn {
      border: 2px solid var(--border);
      background: var(--surface);
      color: var(--text);
      padding: 4px 8px;
      font-size: var(--fs-9);
      font-weight: 600;
      font-family: var(--font-family);
      cursor: pointer;
      transition: var(--transition);
      border-radius: var(--radius);
    }
    .btn:hover {
      background: var(--surface-hover);
      border-color: var(--accent);
    }
    .btn.active {
      background: var(--text);
      color: var(--surface);
      border-color: var(--text);
    }

    /* Stats */
    .stats {
      display: flex;
      gap: 24px;
      margin-bottom: 8px;
      font-size: var(--fs-9);
      color: var(--text-secondary);
    }
    .stat-value {
      color: var(--text);
      font-weight: 700;
      font-family: var(--font-mono);
    }

    /* Breadcrumb */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 8px;
      font-size: var(--fs-9);
      color: var(--text-secondary);
    }
    .breadcrumb a {
      color: var(--text-secondary);
      text-decoration: underline;
      cursor: pointer;
    }
    .breadcrumb a:hover { color: var(--text); }
    .breadcrumb .sep { color: var(--text-disabled); }
    .breadcrumb .current { color: var(--text); font-weight: 600; }
    .back-btn {
      background: var(--surface);
      border: 2px solid var(--border);
      color: var(--text);
      padding: 2px 6px;
      font-size: var(--fs-8);
      cursor: pointer;
      margin-right: 8px;
      border-radius: var(--radius);
    }
    .back-btn:hover { border-color: var(--accent); }

    /* Treemap */
    #treemap-container {
      position: relative;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--surface);
    }
    #treemap {
      display: block;
      width: 100%;
      height: 500px;
    }
    .node {
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .node:hover { opacity: 0.85; }
    .node-rect {
      stroke: var(--surface);
      stroke-width: 1px;
    }
    .node-label {
      font-size: var(--fs-9);
      font-weight: 600;
      fill: #fff;
      pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .node-value {
      font-size: var(--fs-8);
      font-family: var(--font-mono);
      fill: rgba(255,255,255,0.8);
      pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .loading {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-disabled);
      font-size: var(--fs-10);
    }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.1s;
      z-index: 1000;
      min-width: 160px;
      font-size: var(--fs-9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .tooltip.visible { opacity: 1; }
    .tooltip-title {
      font-weight: 700;
      margin-bottom: 4px;
      font-size: var(--fs-10);
    }
    .tooltip-value {
      font-size: 16px;
      font-weight: 700;
      font-family: var(--font-mono);
      color: var(--success);
      margin-bottom: 6px;
    }
    .tooltip-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      color: var(--text-secondary);
    }
    .tooltip-row .val { color: var(--text); font-family: var(--font-mono); }

    /* Color scale - muted greens matching design system */
    .color-0 { fill: #e8e8e8; }
    .color-1 { fill: #c8e6c9; }
    .color-2 { fill: #a5d6a7; }
    .color-3 { fill: #81c784; }
    .color-4 { fill: #66bb6a; }
    .color-5 { fill: #4caf50; }
    .color-6 { fill: #43a047; }
    .color-7 { fill: #388e3c; }
    .color-8 { fill: #2e7d32; }
    .color-9 { fill: #1b5e20; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Market Map</div>
      <div class="controls">
        <button class="btn active" data-metric="value">Value</button>
        <button class="btn" data-metric="count">Volume</button>
        <button class="btn" data-metric="avg">Avg Price</button>
      </div>
    </div>

    <div class="stats">
      <div>Total <span class="stat-value" id="total-value">—</span></div>
      <div>Vehicles <span class="stat-value" id="total-count">—</span></div>
      <div>Avg <span class="stat-value" id="avg-price">—</span></div>
    </div>

    <div class="breadcrumb" id="breadcrumb">
      <span class="current">All Sources</span>
    </div>

    <div id="treemap-container">
      <svg id="treemap"></svg>
      <div class="loading" id="loading">Loading...</div>
    </div>
  </div>

  <div class="tooltip" id="tooltip">
    <div class="tooltip-title"></div>
    <div class="tooltip-value"></div>
    <div class="tooltip-stats"></div>
  </div>

  <script>
    const API = 'https://qkgaybvrernstplzjaam.supabase.co/functions/v1/treemap-vehicles';

    // Server now handles normalization - passthrough
    const normalize = n => n;

    // Format helpers
    const fmtMoney = n => n >= 1e9 ? '$'+(n/1e9).toFixed(2)+'B' : n >= 1e6 ? '$'+(n/1e6).toFixed(1)+'M' : n >= 1e3 ? '$'+(n/1e3).toFixed(0)+'K' : '$'+n;
    const fmtNum = n => n.toLocaleString();

    // State
    let data = null, metric = 'value', filters = {}, history = [];

    // Color scale (quantile)
    function getColor(val, max) {
      const t = Math.sqrt(val / (max || 1));
      const i = Math.min(9, Math.floor(t * 10));
      return `color-${i}`;
    }

    // Fetch
    async function load(f = {}) {
      document.getElementById('loading').style.display = 'block';
      const p = new URLSearchParams();
      if (f.source) p.set('source', f.source);
      if (f.make) p.set('make', f.make);
      if (f.model) p.set('model', f.model);
      if (f.year) p.set('year', f.year);

      try {
        const r = await fetch(`${API}?${p}`);
        const d = await r.json();
        if (d.error) throw new Error(d.error);
        data = d;
        filters = f;
        render();
      } catch(e) {
        console.error(e);
        document.getElementById('loading').textContent = 'Error';
      }
    }

    // Navigate
    function nav(f) {
      history.push({...filters});
      load(f);
    }
    function back() {
      if (history.length) load(history.pop());
    }

    // Update UI
    function updateStats() {
      if (!data?.stats) return;
      const {totalValue, totalCount} = data.stats;
      document.getElementById('total-value').textContent = fmtMoney(totalValue);
      document.getElementById('total-count').textContent = fmtNum(totalCount);
      document.getElementById('avg-price').textContent = fmtMoney(totalCount > 0 ? totalValue/totalCount : 0);
    }

    function updateBreadcrumb() {
      const bc = document.getElementById('breadcrumb');
      let html = history.length ? '<button class="back-btn" onclick="back()">←</button>' : '';
      const parts = ['<a onclick="load({})">All</a>'];
      if (filters.source) {
        if (filters.make) parts.push(`<a onclick="nav({source:'${filters.source}'})">${normalize(filters.source)}</a>`);
        else parts.push(`<span class="current">${normalize(filters.source)}</span>`);
      }
      if (filters.make) {
        if (filters.model) parts.push(`<a onclick="nav({source:'${filters.source}',make:'${filters.make}'})">${filters.make}</a>`);
        else parts.push(`<span class="current">${filters.make}</span>`);
      }
      if (filters.model) {
        if (filters.year) parts.push(`<a onclick="nav({source:'${filters.source}',make:'${filters.make}',model:'${filters.model}'})">${filters.model}</a>`);
        else parts.push(`<span class="current">${filters.model}</span>`);
      }
      if (filters.year) parts.push(`<span class="current">${filters.year}</span>`);
      bc.innerHTML = html + parts.join('<span class="sep">›</span>');
    }

    // Render treemap with zoom transition
    function render() {
      document.getElementById('loading').style.display = 'none';
      updateStats();
      updateBreadcrumb();
      if (!data?.hierarchy) return;

      const container = document.getElementById('treemap');
      const width = container.clientWidth || 1200;
      const height = 500;

      // Clear and setup SVG
      d3.select('#treemap').selectAll('*').remove();
      const svg = d3.select('#treemap').attr('width', width).attr('height', height);

      // Build hierarchy
      const root = d3.hierarchy(data.hierarchy)
        .sum(d => {
          if (metric === 'count') return d.count || 0;
          if (metric === 'avg') return d.count > 0 ? (d.value||0)/d.count : 0;
          return d.value || 0;
        })
        .sort((a,b) => b.value - a.value);

      d3.treemap()
        .size([width, height])
        .paddingOuter(2)
        .paddingInner(1)
        .round(true)(root);

      const maxVal = d3.max(root.leaves(), d => d.value) || 1;

      // Create nodes with transition
      const nodes = svg.selectAll('g')
        .data(root.leaves())
        .join('g')
        .attr('class', 'node')
        .attr('transform', d => `translate(${d.x0},${d.y0})`)
        .style('opacity', 0);

      // Animate in
      nodes.transition()
        .duration(300)
        .style('opacity', 1);

      // Rectangles
      nodes.append('rect')
        .attr('class', d => `node-rect ${getColor(d.value, maxVal)}`)
        .attr('width', d => Math.max(0, d.x1 - d.x0))
        .attr('height', d => Math.max(0, d.y1 - d.y0))
        .attr('rx', 2)
        .on('mouseover', showTip)
        .on('mousemove', moveTip)
        .on('mouseout', hideTip)
        .on('click', click);

      // Labels
      nodes.filter(d => (d.x1-d.x0) > 40 && (d.y1-d.y0) > 20)
        .append('text')
        .attr('class', 'node-label')
        .attr('x', 4)
        .attr('y', 12)
        .text(d => {
          const n = normalize(d.data.name);
          const max = Math.floor((d.x1-d.x0-8)/5.5);
          return n.length > max ? n.slice(0,max)+'…' : n;
        });

      // Values
      nodes.filter(d => (d.x1-d.x0) > 35 && (d.y1-d.y0) > 32)
        .append('text')
        .attr('class', 'node-value')
        .attr('x', 4)
        .attr('y', 22)
        .text(d => {
          if (metric === 'count') return fmtNum(d.data.count);
          if (metric === 'avg') return fmtMoney(d.data.count > 0 ? d.data.value/d.data.count : 0);
          return fmtMoney(d.data.value);
        });
    }

    // Click handler
    function click(e, d) {
      const lvl = data?.stats?.level;
      if (d.data.isVehicle) {
        // Vehicle clicked - could open detail view
        window.open(`/vehicle/${d.data.id}`, '_blank');
        return;
      }
      if (lvl === 'sources') nav({source: d.data.name});
      else if (lvl === 'makes') nav({...filters, make: d.data.name});
      else if (lvl === 'models') nav({...filters, model: d.data.name});
      else if (lvl === 'years') nav({...filters, year: d.data.name});
    }

    // Tooltip
    function showTip(e, d) {
      const tt = document.getElementById('tooltip');
      const total = data?.stats?.totalValue || 1;
      const pct = ((d.data.value/total)*100).toFixed(1);
      const avg = d.data.count > 0 ? d.data.value/d.data.count : 0;

      let val;
      if (metric === 'count') val = fmtNum(d.data.count) + ' vehicles';
      else if (metric === 'avg') val = fmtMoney(avg);
      else val = fmtMoney(d.data.value);

      tt.querySelector('.tooltip-title').textContent = normalize(d.data.name);
      tt.querySelector('.tooltip-value').textContent = val;
      tt.querySelector('.tooltip-stats').innerHTML = `
        <div class="tooltip-row"><span>${pct}%</span><span class="val">of total</span></div>
        <div class="tooltip-row"><span>${fmtNum(d.data.count)}</span><span class="val">vehicles</span></div>
        <div class="tooltip-row"><span>${fmtMoney(d.data.value)}</span><span class="val">value</span></div>
        <div class="tooltip-row"><span>${fmtMoney(avg)}</span><span class="val">avg</span></div>
      `;
      tt.classList.add('visible');
    }
    function moveTip(e) {
      const tt = document.getElementById('tooltip');
      const r = tt.getBoundingClientRect();
      tt.style.left = Math.min(e.clientX+10, window.innerWidth-r.width-10)+'px';
      tt.style.top = Math.min(e.clientY+10, window.innerHeight-r.height-10)+'px';
    }
    function hideTip() {
      document.getElementById('tooltip').classList.remove('visible');
    }

    // Controls
    document.querySelectorAll('.btn[data-metric]').forEach(b => {
      b.addEventListener('click', () => {
        document.querySelectorAll('.btn[data-metric]').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        metric = b.dataset.metric;
        render();
      });
    });

    window.addEventListener('resize', render);
    load();
  </script>
</body>
</html>
