<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nuke Source Distribution (Live)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #222;
    }
    .title { font-size: 22px; font-weight: 600; }
    .title span { text-decoration: underline; text-underline-offset: 3px; }
    .controls { display: flex; gap: 8px; }
    .btn {
      background: transparent;
      border: 1px solid #333;
      color: #888;
      padding: 6px 14px;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
      transition: all 0.15s;
    }
    .btn:hover { background: #1a1a1a; color: #e0e0e0; }
    .btn.active { background: #1a1a1a; border-color: #444; color: #e0e0e0; }
    .stats-row {
      display: flex;
      gap: 40px;
      margin-bottom: 15px;
      font-size: 13px;
      color: #666;
    }
    .stat-value { color: #e0e0e0; font-weight: 500; }
    .breadcrumb { margin-bottom: 12px; font-size: 13px; color: #666; }
    .breadcrumb a { color: #666; text-decoration: underline; cursor: pointer; }
    .breadcrumb a:hover { color: #e0e0e0; }
    .breadcrumb .sep { margin: 0 8px; }
    .breadcrumb .current { color: #e0e0e0; }
    #treemap { width: 100%; height: 550px; border: 1px solid #222; background: #0d0d0d; }
    .node { stroke: #0a0a0a; stroke-width: 1.5px; cursor: pointer; transition: opacity 0.15s; }
    .node:hover { opacity: 0.8; }
    .node-label { font-size: 11px; fill: #000; pointer-events: none; font-weight: 500; }
    .node-value { font-size: 10px; fill: #000; pointer-events: none; opacity: 0.7; }
    .tooltip {
      position: fixed;
      background: #000;
      border: 1px solid #333;
      padding: 12px 16px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.1s;
      z-index: 1000;
      min-width: 180px;
      font-size: 12px;
    }
    .tooltip.visible { opacity: 1; }
    .tooltip-title { font-size: 13px; margin-bottom: 6px; color: #e0e0e0; }
    .tooltip-value { font-size: 24px; font-weight: 600; color: #7fff00; margin-bottom: 10px; }
    .tooltip-row { display: flex; justify-content: space-between; margin-bottom: 3px; color: #666; }
    .tooltip-row .val { color: #e0e0e0; }
    .legend { display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap; font-size: 11px; color: #666; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-color { width: 12px; height: 12px; border-radius: 2px; }
    .loading { text-align: center; padding: 100px; color: #666; }
    .status-legend { margin-left: 30px; display: flex; gap: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Nuke <span>Source Distribution</span></div>
      <div class="controls">
        <button class="btn active" data-metric="universe">Universe</button>
        <button class="btn" data-metric="extracted">Extracted</button>
        <button class="btn" data-metric="quality">Quality</button>
      </div>
    </div>
    <div class="stats-row">
      <div>Sources: <span class="stat-value" id="total-sources">-</span></div>
      <div>Universe: <span class="stat-value" id="total-universe">-</span></div>
      <div>Extracted: <span class="stat-value" id="total-extracted">-</span></div>
      <div>Coverage: <span class="stat-value" id="coverage">-</span></div>
    </div>
    <div class="breadcrumb" id="breadcrumb"><span class="current">All Sources</span></div>
    <svg id="treemap"></svg>
    <div class="legend" id="legend"></div>
  </div>
  <div class="tooltip" id="tooltip">
    <div class="tooltip-title"></div>
    <div class="tooltip-value"></div>
    <div class="tooltip-stats"></div>
  </div>

  <script>
    const API_URL = 'https://qkgaybvrernstplzjaam.supabase.co/functions/v1/treemap-data';

    // Category colors
    const categoryColors = {
      auction: '#4a7c59',
      marketplace: '#5c6b73',
      forum: '#7a6c5d',
      registry: '#5d6d7e',
      dealer: '#6b5b4f',
      social_media: '#6c5b7b',
      aggregator: '#5a6a7a',
      owner: '#7a5a5a',
      internal: '#4a4a4a'
    };

    const statusColors = {
      active: '#7fff00',
      blocked: '#ff6b6b',
      pending: '#ffd93d',
      degraded: '#ff9f43',
      not_started: '#888'
    };

    let sourceData = [];
    let censusData = [];
    let currentMetric = 'universe';
    let currentRoot = null;

    // Fetch data from edge function
    async function fetchData() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();

        if (data.error) throw new Error(data.error);

        sourceData = data.sources;
        renderAll();
      } catch (err) {
        console.error('Fetch error:', err);
        document.getElementById('treemap').innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#666">Error loading data</text>';
      }
    }

    function formatNum(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
      return n.toString();
    }

    function updateStats() {
      const total = sourceData.length;
      const universe = sourceData.reduce((s, d) => s + (d.universe || 0), 0);
      const extracted = sourceData.reduce((s, d) => s + (d.extracted || 0), 0);

      document.getElementById('total-sources').textContent = total;
      document.getElementById('total-universe').textContent = formatNum(universe);
      document.getElementById('total-extracted').textContent = formatNum(extracted);
      document.getElementById('coverage').textContent = ((extracted / universe) * 100).toFixed(3) + '%';
    }

    function buildHierarchy(data, metric = 'universe') {
      const categories = {};
      data.forEach(source => {
        const cat = source.category || 'other';
        if (!categories[cat]) {
          categories[cat] = { name: cat.replace('_', ' '), category: cat, children: [] };
        }
        let value;
        switch(metric) {
          case 'extracted': value = Math.max(source.extracted, 1); break;
          case 'quality': value = (source.quality || 0.5) * 100; break;
          default: value = source.universe || 1000;
        }
        categories[cat].children.push({ ...source, value });
      });
      return { name: "All Sources", children: Object.values(categories) };
    }

    function render(data, parent = null) {
      const container = document.getElementById('treemap');
      const width = container.clientWidth || 1200;
      const height = 550;
      container.innerHTML = '';

      const svg = d3.select('#treemap').attr('width', width).attr('height', height);
      const hierarchy = d3.hierarchy(data).sum(d => d.value || 0).sort((a, b) => b.value - a.value);
      d3.treemap().size([width, height]).padding(2).round(true)(hierarchy);
      currentRoot = hierarchy;

      // Breadcrumb
      const bc = document.getElementById('breadcrumb');
      if (!parent) {
        bc.innerHTML = '<span class="current">All Sources</span>';
      } else {
        bc.innerHTML = `<a onclick="renderRoot()">All Sources</a><span class="sep">›</span><span class="current">${parent.name}</span>`;
      }

      const nodes = svg.selectAll('g').data(hierarchy.leaves()).join('g')
        .attr('transform', d => `translate(${d.x0},${d.y0})`);

      nodes.append('rect')
        .attr('class', 'node')
        .attr('width', d => Math.max(0, d.x1 - d.x0))
        .attr('height', d => Math.max(0, d.y1 - d.y0))
        .attr('fill', d => {
          const base = categoryColors[d.data.category] || '#555';
          if (d.data.status === 'blocked') return d3.color(base).darker(0.6);
          if (d.data.status === 'not_started') return d3.color(base).darker(0.9);
          if (d.data.status === 'pending') return d3.color(base).darker(0.3);
          if (d.data.status === 'degraded') return d3.color(base).darker(0.4);
          return base;
        })
        .on('mouseover', showTooltip)
        .on('mousemove', moveTooltip)
        .on('mouseout', hideTooltip)
        .on('click', (e, d) => {
          if (d.parent?.data?.children) {
            render({ name: d.parent.data.name, children: d.parent.data.children }, d.parent.data);
          }
        });

      nodes.filter(d => (d.x1 - d.x0) > 55 && (d.y1 - d.y0) > 25)
        .append('text').attr('class', 'node-label').attr('x', 5).attr('y', 14)
        .text(d => {
          const max = Math.floor((d.x1 - d.x0 - 10) / 6.5);
          return d.data.name.length > max ? d.data.name.slice(0, max) + '…' : d.data.name;
        });

      nodes.filter(d => (d.x1 - d.x0) > 45 && (d.y1 - d.y0) > 40)
        .append('text').attr('class', 'node-value').attr('x', 5).attr('y', 26)
        .text(d => {
          if (currentMetric === 'quality') return d.data.quality ? (d.data.quality * 100).toFixed(0) + '%' : '?';
          if (currentMetric === 'extracted') return formatNum(d.data.extracted);
          return formatNum(d.data.universe);
        });
    }

    function showTooltip(e, d) {
      const tt = document.getElementById('tooltip');
      const total = currentRoot.value;
      const parentVal = d.parent?.value || total;

      let valueDisplay;
      if (currentMetric === 'quality') valueDisplay = d.data.quality ? (d.data.quality * 100).toFixed(0) + '%' : 'N/A';
      else if (currentMetric === 'extracted') valueDisplay = formatNum(d.data.extracted);
      else valueDisplay = formatNum(d.data.universe);

      tt.querySelector('.tooltip-title').textContent = d.data.name;
      tt.querySelector('.tooltip-value').textContent = valueDisplay;
      tt.querySelector('.tooltip-stats').innerHTML = `
        <div class="tooltip-row"><span>${((d.value / total) * 100).toFixed(1)}%</span><span class="val">of Total</span></div>
        <div class="tooltip-row"><span>${((d.value / parentVal) * 100).toFixed(1)}%</span><span class="val">of ${d.parent?.data?.name || 'Category'}</span></div>
        <div class="tooltip-row" style="margin-top:8px;border-top:1px solid #333;padding-top:8px;">
          <span>Status</span><span class="val" style="color:${statusColors[d.data.status] || '#888'}">${d.data.status}</span>
        </div>
        <div class="tooltip-row"><span>Universe</span><span class="val">${formatNum(d.data.universe)}</span></div>
        <div class="tooltip-row"><span>Extracted</span><span class="val">${formatNum(d.data.extracted)}</span></div>
        <div class="tooltip-row"><span>Vehicles</span><span class="val">${formatNum(d.data.vehicles)}</span></div>
        <div class="tooltip-row"><span>Quality</span><span class="val">${d.data.quality ? (d.data.quality * 100).toFixed(0) + '%' : 'N/A'}</span></div>
      `;
      tt.classList.add('visible');
    }

    function moveTooltip(e) {
      const tt = document.getElementById('tooltip');
      const rect = tt.getBoundingClientRect();
      tt.style.left = Math.min(e.clientX + 12, window.innerWidth - rect.width - 15) + 'px';
      tt.style.top = Math.min(e.clientY + 12, window.innerHeight - rect.height - 15) + 'px';
    }

    function hideTooltip() {
      document.getElementById('tooltip').classList.remove('visible');
    }

    function renderRoot() {
      render(buildHierarchy(sourceData, currentMetric));
    }

    function renderAll() {
      updateStats();
      buildLegend();
      renderRoot();
    }

    function buildLegend() {
      const legend = document.getElementById('legend');
      legend.innerHTML = '';
      Object.entries(categoryColors).forEach(([cat, color]) => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `<div class="legend-color" style="background:${color}"></div><span>${cat.replace('_', ' ')}</span>`;
        legend.appendChild(item);
      });
      const statusLeg = document.createElement('div');
      statusLeg.className = 'status-legend';
      statusLeg.innerHTML = Object.entries(statusColors).map(([s, c]) => `<span style="color:${c}">● ${s}</span>`).join('');
      legend.appendChild(statusLeg);
    }

    document.querySelectorAll('.btn[data-metric]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.btn[data-metric]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMetric = btn.dataset.metric;
        renderRoot();
      });
    });

    window.addEventListener('resize', renderRoot);
    fetchData();
  </script>
</body>
</html>
