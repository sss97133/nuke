name: Craigslist Discovery (All Regions)

on:
  schedule:
    # Every 4 hours - covers 100+ regions
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      max_per_region:
        description: 'Max listings per region'
        required: false
        default: '10'

jobs:
  discover-craigslist:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Validate Secrets
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "‚ùå Missing required secrets"
            exit 1
          fi
          echo "‚úÖ Secrets validated"

      - name: Run Craigslist Squarebody Discovery
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üîç Starting Craigslist discovery..."

          RESPONSE=$(curl -sS -w "\nHTTP:%{http_code}\n" -X POST \
            "${SUPABASE_URL%/}/functions/v1/scrape-all-craigslist-squarebodies" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"max_per_region": ${{ github.event.inputs.max_per_region || 10 }}}' \
            --max-time 300)

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1 | sed 's/^HTTP://')
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response (truncated):"
          echo "$BODY" | head -c 2000

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Craigslist discovery completed"
          else
            echo "‚ùå Craigslist discovery failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Run Craigslist Pre-2000 Discovery
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üîç Starting Craigslist pre-2000 discovery..."

          curl -sS -X POST \
            "${SUPABASE_URL%/}/functions/v1/scrape-all-craigslist-2000-and-older" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"max_per_region": 5}' \
            --max-time 300 || echo "Pre-2000 scrape timed out or failed (non-blocking)"

          echo "‚úÖ Pre-2000 discovery attempted"
