<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>L'Officiel Concierge</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #f5f5f5;
    }
    .header {
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
    }
    .header h1 {
      font-size: 1.8rem;
      font-weight: 400;
      letter-spacing: 4px;
      color: #d4af37;
      text-transform: uppercase;
    }
    .header p {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 8px;
      font-style: italic;
    }
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      padding: 20px;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .message {
      max-width: 85%;
      padding: 16px 20px;
      border-radius: 4px;
      line-height: 1.6;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.user {
      align-self: flex-end;
      background: rgba(212, 175, 55, 0.2);
      border: 1px solid rgba(212, 175, 55, 0.4);
      color: #fff;
    }
    .message.assistant {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.9);
    }
    .message.system {
      align-self: center;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.5);
      font-style: italic;
      font-size: 0.9rem;
      text-align: center;
    }
    .message.error {
      background: rgba(220, 53, 69, 0.2);
      border: 1px solid rgba(220, 53, 69, 0.4);
      color: #ff6b6b;
    }
    .typing-indicator {
      align-self: flex-start;
      padding: 16px 20px;
      color: rgba(255, 255, 255, 0.5);
      font-style: italic;
    }
    .typing-indicator span {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    .input-container {
      display: flex;
      gap: 12px;
      padding: 20px 0;
      border-top: 1px solid rgba(212, 175, 55, 0.2);
    }
    .input-container input {
      flex: 1;
      padding: 16px 20px;
      font-size: 1rem;
      font-family: 'Georgia', serif;
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-container input:focus {
      border-color: rgba(212, 175, 55, 0.6);
    }
    .input-container input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }
    .input-container button {
      padding: 16px 32px;
      font-size: 1rem;
      font-family: 'Georgia', serif;
      background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
      color: #1a1a2e;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      transition: all 0.2s;
    }
    .input-container button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }
    .input-container button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .provider-badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 3px;
      background: rgba(212, 175, 55, 0.2);
      color: #d4af37;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>L'Officiel Concierge</h1>
    <p>Your personal luxury assistant</p>
  </div>
  
  <div class="chat-container">
    <div class="messages" id="messages">
      <div class="message system">
        Welcome. I'm here to assist with your luxury needs — Dom Pérignon, fine dining reservations, yacht charters, or any exclusive arrangement. How may I help you today?
      </div>
    </div>
    
    <form class="input-container" id="chatForm">
      <input 
        type="text" 
        id="userInput" 
        placeholder="How may I assist you..." 
        autocomplete="off"
        autofocus
      />
      <button type="submit" id="sendBtn">Send</button>
    </form>
  </div>

  <script>
    const SUPABASE_URL = 'https://qkgaybvrernstplzjaam.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrZ2F5YnZyZXJuc3RwbHpqYWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgzNjkwMjEsImV4cCI6MjA1Mzk0NTAyMX0.lw3dTV1mE1vf7OXDpBLCulj82SoqqXR2eAVLc4wfDlk';

    const messagesDiv = document.getElementById('messages');
    const chatForm = document.getElementById('chatForm');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    const conversationHistory = [
      {
        role: 'system',
        content: `You are an ultra-luxury concierge for high-net-worth individuals in St. Barth and Monaco. Your clients are billionaires who expect:
- Impeccable service and discretion
- Knowledge of the finest champagnes (especially Dom Pérignon vintages), wines, and spirits
- Connections to exclusive restaurants, yachts, jets, and experiences
- Immediate solutions with no excuses

Speak elegantly but efficiently. Anticipate needs. Always provide specific recommendations with details (vendors, prices if known, timing). If you don't know something specific, offer to arrange it or find the answer.`
      }
    ];

    function addMessage(content, role, provider = null) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${role}`;
      msgDiv.textContent = content;
      if (provider) {
        const badge = document.createElement('span');
        badge.className = 'provider-badge';
        badge.textContent = provider;
        msgDiv.appendChild(badge);
      }
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTyping() {
      const typing = document.createElement('div');
      typing.className = 'typing-indicator';
      typing.id = 'typing';
      typing.innerHTML = '<span>Preparing your response...</span>';
      messagesDiv.appendChild(typing);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function hideTyping() {
      const typing = document.getElementById('typing');
      if (typing) typing.remove();
    }

    async function sendMessage(message) {
      addMessage(message, 'user');
      conversationHistory.push({ role: 'user', content: message });
      
      showTyping();
      sendBtn.disabled = true;
      userInput.disabled = true;

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/openai-proxy`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'gpt-4o',
            messages: conversationHistory,
            max_tokens: 500,
            temperature: 0.7
          })
        });

        hideTyping();

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Request failed: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }

        const assistantMessage = data.choices?.[0]?.message?.content || 'I apologize, but I was unable to process your request. Please try again.';
        const provider = data._provider || 'openai';
        
        conversationHistory.push({ role: 'assistant', content: assistantMessage });
        addMessage(assistantMessage, 'assistant', provider === 'anthropic' ? 'Claude' : null);

      } catch (error) {
        hideTyping();
        console.error('Chat error:', error);
        addMessage(`I apologize for the inconvenience. ${error.message || 'Please try again in a moment.'}`, 'error');
      } finally {
        sendBtn.disabled = false;
        userInput.disabled = false;
        userInput.focus();
      }
    }

    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const message = userInput.value.trim();
      if (message) {
        userInput.value = '';
        sendMessage(message);
      }
    });

    // Focus input on load
    userInput.focus();
  </script>
</body>
</html>
