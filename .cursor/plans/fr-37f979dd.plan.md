<!-- 37f979dd-7eec-442d-b4c2-97a68d76ae8f b2e3d6ec-9008-4083-b572-2a6d6443425b -->
# Guaranteed Approach to Fix Mobile Session Errors

## The Problem

Mobile shows "session is not defined" errors despite multiple attempted fixes. The issue is:

1. Multiple session errors exist across the codebase
2. Deployments are not reflecting the latest fixes (bundle mismatch)
3. We've been fixing errors one at a time reactively

## Guaranteed Solution: Systematic Approach

### Step 1: Find ALL Session Errors (No Guessing)

Run comprehensive search to find EVERY instance where `session.user`, `session.id`, or `session.` is accessed without proper optional chaining:

```bash
# Search pattern: session. without ?. before it
grep -rn "[^?]\bsession\s*\." nuke_frontend/src/ --include="*.tsx" --include="*.ts"
```

Create a list of EVERY file and line number that needs fixing.

### Step 2: Fix ALL Errors in ONE Commit

Go through the list systematically:

- For each `session.user` â†’ change to `session?.user`  
- For each `session.id` â†’ change to `session?.id`
- Verify the fix is inside proper guards or add guards if missing

Files already identified that need fixing:

- `VehicleOwnershipPanel.tsx` (lines 259, 294, 425, 583, 637)
- Any other files found in Step 1

### Step 3: Build Locally and Test Bundle Name

```bash
cd nuke_frontend
npm run build
# Note the bundle name (e.g., index-XXXXX.js)
```

### Step 4: Commit and Push with Clear Marker

```bash
git add -A
git commit -m "ðŸ”¥ FINAL SESSION FIX: All session refs now use optional chaining"
git push origin main
```

### Step 5: Force Vercel Rebuild (Multiple Methods)

Try methods in order until one works:

**Method A: Vercel CLI Force Deploy**

```bash
cd /Users/skylar/nuke
vercel --prod --force
```

**Method B: Vercel API Redeploy**

```bash
# Get latest deployment
vercel ls
# Force redeploy the latest
vercel redeploy [deployment-url] --prod
```

**Method C: GitHub Action (Nuclear Option)**

```bash
# Create empty commit to trigger webhook
git commit --allow-empty -m "Force Vercel rebuild"
git push origin main
```

**Method D: Manual Vercel Dashboard**

- Go to https://vercel.com/nzero/nuke/deployments
- Click latest deployment
- Click "Redeploy" â†’ "Use existing Build Cache" â†’ NO
- Click "Redeploy"

### Step 6: Verify Deployment (DO NOT SKIP)

Wait 3 minutes, then check:

```bash
# Check live bundle name
curl -s https://n-zero.dev/ | grep -o 'index-[A-Za-z0-9_-]*\.js'
```

**If bundle name doesn't match local build, deployment failed. Try next method in Step 5.**

### Step 7: Test Mobile Session Error

Use browser automation to verify:

1. Navigate to vehicle page
2. Resize to mobile (375x667)
3. Check console for "session is not defined" error
4. If error exists, repeat Steps 1-6

### Step 8: Add Missing Supabase URL

```bash
echo 'VITE_SUPABASE_URL=https://qkgaybvrernstplzjaam.supabase.co' >> .env.local
```

## Why This is Guaranteed

- âœ… Finds ALL errors, not just some
- âœ… Fixes everything in one commit
- âœ… Multiple deployment methods (fallback options)
- âœ… Verification step prevents false confidence
- âœ… Tests the actual live site, not assumptions

## Success Criteria

1. âœ… No grep results for unsafe session access
2. âœ… Local bundle name matches live bundle name
3. âœ… Mobile browser shows NO "session is not defined" errors
4. âœ… Vehicle profile loads on mobile without blank screen

This approach eliminates guesswork and ensures the fix actually reaches production.

### To-dos

- [ ] Create market auction system migration with shares, orders, trades, holdings tables
- [ ] Build auctionMarketEngine.ts with order matching, price discovery, share pricing algorithms
- [ ] Build MarketTicker component showing live price + buy/sell buttons
- [ ] Build OrderBook component showing bid/ask levels with click-to-fill
- [ ] Build Portfolio component with holdings, gains, and quick-sell interface
- [ ] Build Leaderboard component showing top traders and daily rankings
- [ ] Create AUCTION_MARKET_ENGINE.md with algorithm docs and examples